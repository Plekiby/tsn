<!doctype html>
<html>
  <body>
    <%- include("../partials/topnav", { unreadCount }) %>
    <h2>Messages</h2>

    <hr />

    <% if (!conversations || conversations.length === 0) { %>
      <p>Aucune conversation. DÃ©marrez une discussion depuis un profil utilisateur.</p>
    <% } %>

    <% (conversations || []).forEach(conv => { %>
      <div style="border:1px solid #ddd; padding:12px; margin:10px 0; background:#fff;">
        <a href="/messages/<%= conv.id %>" style="text-decoration:none; color:inherit;">
          <div style="display:flex; align-items:center; gap:10px;">
            <% if (conv.isGroup) { %>
              <div style="width:50px; height:50px; border-radius:50%; background:#667eea; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:bold;">
                G
              </div>
              <div style="flex:1;">
                <strong><%= conv.groupName %></strong>
                <div style="font-size:12px; opacity:0.7;">Groupe</div>
              </div>
            <% } else { %>
              <% const other = conv.otherMembers[0]; %>
              <% if (other?.avatar) { %>
                <img src="<%= other.avatar %>" style="width:50px; height:50px; border-radius:50%; object-fit:cover;" />
              <% } else { %>
                <div style="width:50px; height:50px; border-radius:50%; background:#ddd; display:flex; align-items:center; justify-content:center; font-weight:bold;">
                  <%= other?.displayName?.charAt(0)?.toUpperCase() || '?' %>
                </div>
              <% } %>
              <div style="flex:1;">
                <strong><%= other?.displayName || 'Utilisateur inconnu' %></strong>
                <% if (conv.lastMessage) { %>
                  <div style="font-size:13px; opacity:0.7; margin-top:4px;">
                    <%= conv.lastMessage.sender.displayName %>: <%= conv.lastMessage.content.substring(0, 50) %><%= conv.lastMessage.content.length > 50 ? '...' : '' %>
                  </div>
                <% } %>
              </div>
            <% } %>

            <div style="text-align:right;">
              <% if (conv.unreadCount > 0) { %>
                <div style="background:#111; color:#fff; border-radius:999px; padding:2px 8px; font-size:12px; display:inline-block;">
                  <%= conv.unreadCount %>
                </div>
              <% } %>
              <div style="font-size:12px; opacity:0.6; margin-top:4px;">
                <%= new Date(conv.updatedAt).toLocaleDateString() %>
              </div>
            </div>
          </div>
        </a>
      </div>
    <% }) %>
  </body>
</html>
