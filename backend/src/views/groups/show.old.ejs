<!doctype html>
<html>
  <body>    
    <%- include("../partials/topnav", { unreadCount }) %>

    <h2>Group: <%= group.name %></h2>

    <% // ✅ CHANGE ICI si tu es en prod AlwaysData : %>
    <% const baseUrl = "http://localhost:3000"; %>
    <% if (member && (member.role === "OWNER" || member.role === "ADMIN")) { %>
      <form method="POST" action="/groups/<%= group.id %>/invite-link">
        <button type="submit">Générer un lien d’invitation</button>
      </form>

      <% if (inviteToken) { %>
        <div style="margin-top:8px; font-size:12px;">
          Lien :
          <input
            value="<%= baseUrl + '/groups/invite/accept?token=' + inviteToken %>"
            style="width:520px;"
            readonly
          />
        </div>
      <% } %>
    <% } %>

    <div style="margin-bottom:10px;">
      <a href="/groups">← Back groups</a> |
      <a href="/posts/feed">Feed</a> |
      <a href="/notifications">Notifications</a>
    </div>

    <div style="font-size:12px; opacity:0.7;">
      privacy: <%= group.privacy %> • owner: <%= group.owner.displayName %> • members: <%= group._count.members %>
    </div>

    <% if (group.description) { %>
      <div style="margin-top:10px;"><%= group.description %></div>
    <% } %>

    <hr />

    <% if (!member) { %>
      <% if (group.privacy !== "SECRET") { %>
        <form method="POST" action="/groups/<%= group.id %>/join">
          <button type="submit">Join group</button>
        </form>
      <% } else { %>
        <p style="opacity:0.7;">Groupe SECRET : accès uniquement via lien d’invitation.</p>
      <% } %>

      <p style="opacity:0.7;">Tu dois rejoindre le groupe pour voir les posts & events.</p>
    <% } else { %>
      <div style="font-size:12px; opacity:0.7;">Role: <%= member.role %></div>

      <% if (member.role !== "OWNER") { %>
        <form method="POST" action="/groups/<%= group.id %>/leave">
          <button type="submit">Leave group</button>
        </form>
      <% } %>

      <hr />

      <h3>Publier dans le groupe</h3>
      <form method="POST" action="/groups/<%= group.id %>/posts">
        <textarea name="content" rows="3" placeholder="Écrire un post..." style="width:420px;"></textarea>
        <br /><br />
        <button type="submit">Publier</button>
      </form>

      <hr />

      <h3>Events</h3>

      <h4>Créer un event</h4>
      <form method="POST" action="/groups/<%= group.id %>/events">
        <input name="title" placeholder="Titre" style="width:420px;" />
        <br /><br />
        <input name="location" placeholder="Lieu (optionnel)" style="width:420px;" />
        <br /><br />
        <textarea name="description" rows="3" placeholder="Description (optionnel)" style="width:420px;"></textarea>
        <br /><br />

        <label>Start:</label>
        <input type="datetime-local" name="startAt" />
        <br /><br />
        <label>End:</label>
        <input type="datetime-local" name="endAt" />
        <br /><br />

        <button type="submit">Créer</button>
      </form>

      <hr />

      <% if (!events || events.length === 0) { %>
        <p>Aucun event.</p>
      <% } else { %>
        <% events.forEach(ev => { %>
          <div style="border:1px solid #ddd; padding:10px; margin:10px 0;">
            <div><strong><%= ev.title %></strong></div>

            <div style="font-size:12px; opacity:0.7; margin-top:6px;">
              start: <%= new Date(ev.startAt).toLocaleString() %>
              <% if (ev.location) { %> • <%= ev.location %><% } %>
              • by <%= ev.creator.displayName %>
              • attendees: <%= ev._count.attendees %>
            </div>

            <% if (ev.description) { %>
              <div style="margin-top:6px;"><%= ev.description %></div>
            <% } %>

            <form method="POST" action="/events/<%= ev.id %>/rsvp" style="margin-top:8px;">
              <select name="status">
                <option value="GOING">GOING</option>
                <option value="DECLINED">DECLINED</option>
              </select>
              <button type="submit">RSVP</button>
            </form>
          </div>
        <% }) %>
      <% } %>

      <hr />

      <h3>Posts</h3>
      <% if (!posts || posts.length === 0) { %>
        <p>Aucun post.</p>
      <% } else { %>
        <% posts.forEach(p => { %>
          <div style="border:1px solid #ddd; padding:10px; margin:10px 0;">
            <strong><%= p.author.displayName %></strong>
            <div style="font-size:12px; opacity:0.7;">
              <%= new Date(p.createdAt).toLocaleString() %>
            </div>

            <div style="margin-top:8px;"><%= p.content %></div>

            <div style="margin-top:8px;">
              likes: <%= p._count.likes %> • comments: <%= p._count.comments %>
            </div>

            <form method="POST" action="/posts/<%= p.id %>/like">
              <button type="submit">Like / Unlike</button>
            </form>

            <form method="POST" action="/posts/<%= p.id %>/comments" style="margin-top:8px;">
              <input name="content" placeholder="Ajouter un commentaire..." style="width:320px;" />
              <button type="submit">Comment</button>
            </form>

            <% if (p.comments && p.comments.length > 0) { %>
              <div style="margin-top:8px; padding-left:10px; border-left:2px solid #eee;">
                <% p.comments.forEach(c => { %>
                  <div style="margin:6px 0;">
                    <strong><%= c.user.displayName %></strong> :
                    <%= c.content %>
                  </div>
                <% }) %>
              </div>
            <% } %>
          </div>
        <% }) %>
      <% } %>
    <% } %>
  </body>
</html>
