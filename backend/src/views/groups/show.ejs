<%- include("../partials/header", { pageTitle: "Groupe - " + group.name, unreadCount, unreadMessages, user }) %>

<div class="container my-4">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-3">
        <i class="bi bi-people"></i> <%= group.name %>
      </h2>

      <% // CHANGE ICI si tu es en prod AlwaysData : %>
      <% const baseUrl = "http://localhost:3000"; %>

      <!-- Invitations (OWNER/ADMIN only) -->
      <% if (member && (member.role === "OWNER" || member.role === "ADMIN")) { %>
        <div class="card mb-3">
          <div class="card-header bg-light">
            <h6 class="mb-0"><i class="bi bi-person-plus-fill"></i> Invitations</h6>
          </div>
          <div class="card-body">
            <!-- Générer lien d'invitation -->
            <div class="mb-3">
              <form method="POST" action="/groups/<%= group.id %>/invite-link">
                <button type="submit" class="btn btn-secondary btn-sm">
                  <i class="bi bi-link-45deg"></i> Générer un lien d'invitation
                </button>
              </form>

              <% if (inviteToken) { %>
                <div class="mt-2">
                  <label class="form-label small">Lien d'invitation :</label>
                  <div class="input-group input-group-sm">
                    <input
                      type="text"
                      class="form-control"
                      value="<%= baseUrl + '/groups/invite/accept?token=' + inviteToken %>"
                      readonly
                    />
                    <button class="btn btn-outline-secondary" type="button" onclick="navigator.clipboard.writeText(this.previousElementSibling.value)">
                      <i class="bi bi-clipboard"></i>
                    </button>
                  </div>
                </div>
              <% } %>
            </div>

            <hr>

            <!-- Inviter des utilisateurs spécifiques -->
            <div>
              <label class="form-label small fw-bold">
                <i class="bi bi-envelope"></i> Inviter des utilisateurs
              </label>

              <% if (!nonMembers || nonMembers.length === 0) { %>
                <div class="alert alert-info alert-sm mb-0">
                  <small><i class="bi bi-info-circle"></i> Aucun utilisateur disponible à inviter.</small>
                </div>
              <% } else { %>
                <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                  <% nonMembers.forEach(u => { %>
                    <div class="list-group-item px-0 d-flex justify-content-between align-items-center">
                      <div>
                        <div class="fw-bold"><%= u.displayName %></div>
                        <small class="text-muted"><%= u.email %></small>
                      </div>
                      <form method="POST" action="/groups/<%= group.id %>/invite/<%= u.id %>" class="d-inline">
                        <button type="submit" class="btn btn-primary btn-sm">
                          <i class="bi bi-send"></i> Inviter
                        </button>
                      </form>
                    </div>
                  <% }) %>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      <% } %>

      <div class="mb-3">
        <a href="/groups" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-arrow-left"></i> Groupes
        </a>
        <a href="/posts/feed" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-newspaper"></i> Feed
        </a>
        <a href="/notifications" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-bell"></i> Notifications
        </a>
      </div>

      <div class="small text-muted mb-3">
        <i class="bi bi-shield"></i> <%= group.privacy %> •
        <i class="bi bi-person"></i> <%= group.owner.displayName %> •
        <i class="bi bi-people"></i> <%= group._count.members %> membres
      </div>

      <% if (group.description) { %>
        <div class="alert alert-light">
          <%= group.description %>
        </div>
      <% } %>

      <hr class="mb-4">

      <!-- Non membre -->
      <% if (!member) { %>
        <% if (group.privacy !== "SECRET") { %>
          <div class="alert alert-warning">
            <i class="bi bi-info-circle"></i> Tu dois rejoindre le groupe pour voir les posts & events.
            <form method="POST" action="/groups/<%= group.id %>/join" class="mt-2">
              <button type="submit" class="btn btn-primary btn-sm">
                <i class="bi bi-box-arrow-in-right"></i> Rejoindre le groupe
              </button>
            </form>
          </div>
        <% } else { %>
          <div class="alert alert-danger">
            <i class="bi bi-lock"></i> Groupe SECRET : accès uniquement via lien d'invitation.
          </div>
        <% } %>
      <% } else { %>
        <!-- Membre -->
        <div class="mb-3">
          <span class="badge bg-secondary">Role: <%= member.role %></span>
          <% if (member.role !== "OWNER") { %>
            <form method="POST" action="/groups/<%= group.id %>/leave" class="d-inline ms-2">
              <button type="submit" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-box-arrow-right"></i> Quitter le groupe
              </button>
            </form>
          <% } %>
        </div>

        <hr class="mb-4">

        <!-- Publier dans le groupe -->
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-pen"></i> Publier dans le groupe</h5>
          </div>
          <div class="card-body">
            <form method="POST" action="/groups/<%= group.id %>/posts">
              <textarea
                class="form-control mb-3"
                name="content"
                rows="3"
                placeholder="Écrire un post..."
                required
              ></textarea>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-send"></i> Publier
              </button>
            </form>
          </div>
        </div>

        <hr class="mb-4">

        <!-- Events -->
        <div class="mb-5">
          <h3 class="h5 mb-3"><i class="bi bi-calendar-event"></i> Events</h3>

          <!-- Créer un event -->
          <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
              <h6 class="mb-0"><i class="bi bi-plus-circle"></i> Créer un event</h6>
            </div>
            <div class="card-body">
              <form method="POST" action="/groups/<%= group.id %>/events">
                <div class="mb-3">
                  <label for="title" class="form-label">Titre</label>
                  <input
                    type="text"
                    class="form-control"
                    id="title"
                    name="title"
                    placeholder="Titre de l'événement"
                    required
                  />
                </div>

                <div class="mb-3">
                  <label for="location" class="form-label">Lieu (optionnel)</label>
                  <input
                    type="text"
                    class="form-control"
                    id="location"
                    name="location"
                    placeholder="Lieu"
                  />
                </div>

                <div class="mb-3">
                  <label for="description" class="form-label">Description (optionnel)</label>
                  <textarea
                    class="form-control"
                    id="description"
                    name="description"
                    rows="3"
                    placeholder="Description..."
                  ></textarea>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="startAt" class="form-label">Début</label>
                    <input type="datetime-local" class="form-control" id="startAt" name="startAt" required />
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="endAt" class="form-label">Fin</label>
                    <input type="datetime-local" class="form-control" id="endAt" name="endAt" />
                  </div>
                </div>

                <button type="submit" class="btn btn-secondary">
                  <i class="bi bi-calendar-plus"></i> Créer
                </button>
              </form>
            </div>
          </div>

          <!-- Liste des events -->
          <% if (!events || events.length === 0) { %>
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> Aucun event.
            </div>
          <% } else { %>
            <div class="row g-3">
              <% events.forEach(ev => { %>
                <div class="col-12">
                  <div class="card">
                    <div class="card-body">
                      <h5 class="card-title"><%= ev.title %></h5>
                      <div class="small text-muted mb-2">
                        <i class="bi bi-clock"></i> <%= new Date(ev.startAt).toLocaleString() %>
                        <% if (ev.location) { %>
                          • <i class="bi bi-geo-alt"></i> <%= ev.location %>
                        <% } %>
                        • <i class="bi bi-person"></i> <%= ev.creator.displayName %>
                        • <i class="bi bi-people"></i> <%= ev._count.attendees %> participants
                      </div>

                      <% if (ev.description) { %>
                        <p class="card-text"><%= ev.description %></p>
                      <% } %>

                      <form method="POST" action="/events/<%= ev.id %>/rsvp" class="mt-2">
                        <div class="input-group input-group-sm" style="max-width: 300px;">
                          <select class="form-select" name="status">
                            <option value="GOING">GOING</option>
                            <option value="DECLINED">DECLINED</option>
                          </select>
                          <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> RSVP
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              <% }) %>
            </div>
          <% } %>
        </div>

        <hr class="mb-4">

        <!-- Posts -->
        <div>
          <h3 class="h5 mb-3"><i class="bi bi-chat-square-text"></i> Posts</h3>

          <% if (!posts || posts.length === 0) { %>
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> Aucun post.
            </div>
          <% } else { %>
            <div class="row g-3">
              <% posts.forEach(p => { %>
                <div class="col-12">
                  <div class="card">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0"><%= p.author.displayName %></h6>
                        <small class="text-muted"><%= new Date(p.createdAt).toLocaleString() %></small>
                      </div>

                      <p class="card-text"><%= p.content %></p>

                      <div class="small text-muted mb-2">
                        <i class="bi bi-heart"></i> <%= p._count.likes %> •
                        <i class="bi bi-chat"></i> <%= p._count.comments %>
                      </div>

                      <form method="POST" action="/posts/<%= p.id %>/like" class="mb-2">
                        <button type="submit" class="btn btn-outline-primary btn-sm">
                          <i class="bi bi-heart"></i> Like
                        </button>
                      </form>

                      <form method="POST" action="/posts/<%= p.id %>/comments">
                        <div class="input-group input-group-sm">
                          <input
                            type="text"
                            class="form-control"
                            name="content"
                            placeholder="Ajouter un commentaire..."
                            required
                          />
                          <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send"></i>
                          </button>
                        </div>
                      </form>

                      <% if (p.comments && p.comments.length > 0) { %>
                        <div class="mt-3 ps-3 border-start">
                          <% p.comments.forEach(c => { %>
                            <div class="mb-2">
                              <strong class="small"><%= c.user.displayName %></strong>
                              <span class="small">: <%= c.content %></span>
                            </div>
                          <% }) %>
                        </div>
                      <% } %>
                    </div>
                  </div>
                </div>
              <% }) %>
            </div>
          <% } %>
        </div>
      <% } %>
    </div>
  </div>
</div>

<%- include("../partials/footer") %>
