<%- include("../partials/header", { pageTitle: "Recommandations", unreadCount, unreadMessages, user }) %>

<div class="container-fluid my-4" style="max-width: 1200px;">
  <div class="row">
    <div class="col-12 px-2 px-md-0">
      <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
        <h2 class="mb-0">
          <i class="bi bi-stars"></i> Personnes √† d√©couvrir
        </h2>
        <a href="/interests" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-tag"></i> G√©rer mes int√©r√™ts
        </a>
      </div>

      <% if (!reco || reco.length === 0) { %>
        <div class="card border-info shadow-sm">
          <div class="card-body">
            <h5 class="card-title"><i class="bi bi-info-circle"></i> Aucune recommandation pour l'instant</h5>
            <p class="mb-3">Notre algorithme de recommandation intelligent se base sur :</p>
            <ul class="mb-3">
              <li><strong>Vos connexions</strong> : amis d'amis (Friend of Friend)</li>
              <li><strong>Vos int√©r√™ts</strong> : personnes partageant vos passions</li>
              <li><strong>Votre r√©seau</strong> : connexions fortes vs simples follows</li>
            </ul>
            <p class="mb-0"><strong>Pour obtenir des recommandations :</strong></p>
            <ol class="mb-3">
              <li>Ajoutez vos int√©r√™ts sur <a href="/interests">la page des int√©r√™ts</a></li>
              <li>Suivez quelques personnes depuis <a href="/users/all">la liste des utilisateurs</a></li>
              <li>Revenez ici pour voir les recommandations personnalis√©es</li>
            </ol>
            <div class="d-flex gap-2 flex-wrap">
              <a href="/interests" class="btn btn-primary">
                <i class="bi bi-tag"></i> Ajouter mes int√©r√™ts
              </a>
              <a href="/users/all" class="btn btn-secondary">
                <i class="bi bi-people"></i> Voir tous les utilisateurs
              </a>
            </div>
          </div>
        </div>
      <% } else { %>
        <!-- Statistiques -->
        <div class="row g-3 mb-4">
          <div class="col-6 col-md-4">
            <div class="card text-center border-primary shadow-sm">
              <div class="card-body">
                <h3 class="text-primary mb-0"><%= reco.length %></h3>
                <small class="text-muted">Recommandations</small>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-4">
            <div class="card text-center border-success shadow-sm">
              <div class="card-body">
                <h3 class="text-success mb-0">
                  <%= reco.filter(r => r.commonCount > 0).length %>
                </h3>
                <small class="text-muted">Int√©r√™ts communs</small>
              </div>
            </div>
          </div>
          <div class="col-6 col-md-4 mx-auto">
            <div class="card text-center border-warning shadow-sm">
              <div class="card-body">
                <h3 class="text-warning mb-0">
                  <%= reco.filter(r => r.strongMutuals > 0).length %>
                </h3>
                <small class="text-muted">Mutuals en commun</small>
              </div>
            </div>
          </div>
        </div>

        <hr class="my-4">

        <!-- Liste des recommandations -->
        <div class="row g-3">
          <% reco.forEach((u, index) => { %>
            <div class="col-12 col-md-6 col-lg-6">
              <div class="card h-100 <%= index === 0 ? 'border-primary border-2 shadow' : 'shadow-sm' %>">
                <div class="card-body">
                  <!-- En-t√™te avec badge et bouton -->
                  <div class="d-flex justify-content-between align-items-start mb-3 gap-2">
                    <div class="flex-grow-1">
                      <% if (index < 3) { %>
                        <span class="badge <%= index === 0 ? 'bg-warning text-dark' : index === 1 ? 'bg-secondary' : 'bg-info' %> me-2">
                          #<%= index + 1 %> <% if (index === 0) { %>üèÜ<% } else if (index === 1) { %>ü•à<% } else if (index === 2) { %>ü•â<% } %>
                        </span>
                      <% } %>
                      <h5 class="mb-1">
                        <a href="/profiles/<%= u.id %>" class="link-primary text-decoration-none">
                          <%= u.displayName %>
                        </a>
                      </h5>
                    </div>
                    <form method="POST" action="/users/<%= u.id %>/follow" class="d-inline flex-shrink-0">
                      <button type="submit" class="btn btn-primary btn-sm">
                        <i class="bi bi-person-plus"></i>
                      </button>
                    </form>
                  </div>

                  <!-- Bio -->
                  <% if (u.bio) { %>
                    <p class="text-muted small mb-3"><%= u.bio.substring(0, 120) %><%= u.bio.length > 120 ? '...' : '' %></p>
                  <% } %>

                  <!-- Score et badges -->
                  <div class="d-flex flex-wrap gap-2 mb-3">
                    <span class="badge bg-primary">
                      <i class="bi bi-graph-up"></i> Score: <%= Math.round(u.score) %>
                    </span>

                    <% if (u.mutuals > 0) { %>
                      <span class="badge bg-info">
                        <i class="bi bi-people"></i> <%= u.mutuals %>
                      </span>
                    <% } %>

                    <% if (u.commonCount > 0) { %>
                      <span class="badge bg-success">
                        <i class="bi bi-tag-fill"></i> <%= u.commonCount %> (<%=u.interestPercentage%>%)
                      </span>
                    <% } %>
                  </div>

                  <!-- Mutuals -->
                  <% if (u.mutualNames && u.mutualNames.length) { %>
                    <div class="mb-3 pb-3 border-bottom">
                      <small class="text-muted d-block mb-2">
                        <i class="bi bi-arrow-through-heart"></i> <strong>Connexions :</strong>
                      </small>
                      <div class="d-flex flex-wrap gap-1">
                        <% u.mutualNames.slice(0, 3).forEach(name => { %>
                          <span class="badge bg-secondary small"><%= name %></span>
                        <% }) %>
                        <% if (u.mutualNames.length > 3) { %>
                          <span class="badge bg-light text-dark small">+<%= u.mutualNames.length - 3 %></span>
                        <% } %>
                      </div>
                    </div>
                  <% } %>

                  <!-- Int√©r√™ts communs -->
                  <% if (u.commonInterests && u.commonInterests.length) { %>
                    <div class="mb-3">
                      <small class="text-muted d-block mb-2">
                        <i class="bi bi-tag-fill"></i> <strong>Int√©r√™ts :</strong>
                      </small>
                      <div class="d-flex flex-wrap gap-1">
                        <% u.commonInterests.slice(0, 4).forEach(interest => { %>
                          <span class="badge bg-success small"><%= interest %></span>
                        <% }) %>
                        <% if (u.commonInterests.length > 4) { %>
                          <span class="badge bg-light text-dark small">+<%= u.commonInterests.length - 4 %></span>
                        <% } %>
                      </div>
                    </div>
                  <% } %>

                  <!-- Barre de compatibilit√© -->
                  <%
                    const compatScore = Math.min(100, u.interestPercentage + (u.strongMutuals * 15));
                    const progressColor = compatScore >= 70 ? 'success' : compatScore >= 40 ? 'warning' : 'info';
                  %>
                  <% if (compatScore > 0) { %>
                    <div class="mt-3">
                      <small class="text-muted d-block mb-1">Compatibilit√©: <%= compatScore %>%</small>
                      <div class="progress" style="height: 18px;">
                        <div class="progress-bar bg-<%= progressColor %>" role="progressbar"
                             style="width: <%= compatScore %>%"
                             aria-valuenow="<%= compatScore %>" aria-valuemin="0" aria-valuemax="100">
                          <small class="fw-bold"><%= compatScore %>%</small>
                        </div>
                      </div>
                    </div>
                  <% } %>
                </div>
              </div>
            </div>
          <% }) %>
        </div>

        <!-- Explications -->
        <div class="card mt-4 bg-light shadow-sm">
          <div class="card-body">
            <h6 class="card-title"><i class="bi bi-info-circle"></i> Comment fonctionner l'algorithme ?</h6>
            <p class="small mb-2">Notre syst√®me calcule un score bas√© sur :</p>
            <ul class="small mb-0">
              <li><strong>Connexions (√ó10-20 pts)</strong> : personnes suivies par vos contacts</li>
              <li><strong>Int√©r√™ts communs (√ó3 pts)</strong> : chaque passion partag√©e</li>
              <li><strong>Compatibilit√© Jaccard (√ó20 pts max)</strong> : similarit√© globale</li>
            </ul>
          </div>
        </div>
      <% } %>
    </div>
  </div>
</div>

<style>
  @media (max-width: 768px) {
    .card {
      margin: 0 -0.5rem;
    }
  }

  .card {
    transition: all 0.2s ease;
  }

  .card:hover {
    transform: translateY(-2px);
  }
</style>

<%- include("../partials/footer") %>
